<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-eval' 'wasm-unsafe-eval' https://*.google.com https://*.gstatic.com https://apis.google.com https://cdn.jsdelivr.net; script-src-elem 'self' 'unsafe-eval' 'wasm-unsafe-eval' https://*.google.com https://*.gstatic.com https://apis.google.com https://cdn.jsdelivr.net; connect-src 'self' https://openlibrary.org https://*.googleapis.com https://*.google.com https://*.gstatic.com https://firestore.googleapis.com https://cdn.jsdelivr.net https://securetoken.google.com https://identitytoolkit.googleapis.com https://apis.google.com https://firebaseinstallations.googleapis.com https://oauth2.googleapis.com; img-src 'self' https: data:; style-src 'self' 'unsafe-inline'; font-src 'self' data:; media-src 'self' blob: data:; worker-src 'self' blob:; frame-src https://*.google.com https://*.firebaseapp.com https://*.web.app; child-src https://*.google.com https://*.firebaseapp.com https://*.web.app; base-uri 'self'; upgrade-insecure-requests">
  <title>Library Tracker</title>
  <link rel="icon" href="assets/favicon.svg" type="image/svg+xml" />
  <link rel="manifest" href="./manifest.json" />
  <link rel="stylesheet" href="styles/base.css" />
  <link rel="stylesheet" href="styles/auth.css" />

  <link rel="stylesheet" href="styles/shelves.css" />
  <link rel="stylesheet" href="styles/modal.css" />
  <link rel="stylesheet" href="styles/handsfree.css" />
</head>
<body>
  <!-- Firebase (compat) SDKs in head with defer to ensure availability before app runs -->
  <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script defer src="js/firebase-config.js"></script>
  <script defer src="js/firebase.js"></script>
  <header class="app-header">
    <h1>Library Tracker</h1>
    <div class="controls">
      <select id="sort-select" aria-label="Sort books" title="Sort">
        <option value="series" selected>Series (Aâ€“Z)</option>
        <option value="title">Title (Aâ€“Z)</option>
        <option value="author">Author (Aâ€“Z)</option>
        <option value="genre">Genre (Aâ€“Z)</option>
      </select>
      <div class="search-wrap">
        <input id="search-input" type="search" placeholder="Search booksâ€¦" aria-label="Search books" />
        <button id="btn-clear-search" class="icon small" aria-label="Clear search" title="Clear search" hidden>âœ•</button>
        <span id="results-count" class="results-count" aria-live="polite"></span>
      </div>
      <div class="isbn-inline" style="display:flex;gap:6px;align-items:center">
        <input id="isbn-input" type="text" inputmode="numeric" pattern="[-0-9Xx ]+" placeholder="Enter ISBNâ€¦" aria-label="Enter ISBN" />
        <button id="btn-add" aria-label="Add ISBN">Add</button>
      </div>
      <button id="btn-scan" aria-label="Open scanner">Scan</button>
      <button id="toggle-handsfree" aria-pressed="false" aria-label="Motion cursor" title="Motion cursor">âœ‹</button>
      <button id="info-handsfree" class="info-badge" aria-label="How motion cursor works" title="Motion cursor help" tabindex="0">i
        <div class="info-card" role="tooltip" aria-live="polite">
          <strong>Motion cursor</strong>
          <ul>
            <li>Move hand to move the onâ€‘screen cursor</li>
            <li>Pinch + brief hold = click</li>
            <li>Hover briefly to highlight buttons</li>
            <li>Settings â†’ Hands-Free: adjust sensitivity, mirror X, dwell</li>
          </ul>
        </div>
      </button>

      <button id="toggle-voice" aria-pressed="false" aria-label="Voice" title="Voice">ğŸ¤</button>
      <button id="info-voice" class="info-badge" aria-label="How voice works" title="Voice help" tabindex="0">i
        <div class="info-card" role="tooltip" aria-live="polite">
          <strong>Voice (examples)</strong>
          <ul>
            <li>Finding: â€œDo I have Fourth Wing?â€</li>
            <li>Borrowing: â€œLend Fourth Wing to Alexâ€</li>
            <li>Borrow with date: â€œAlex started borrowing Fourth Wing last Tuesdayâ€</li>
            <li>Removing: â€œRemove Fourth Wingâ€ (then say â€œyesâ€)</li>
            <li>Borrower list: â€œWhich books is Alex borrowing?â€</li>
            <li>Whoâ€™s borrowing: â€œWhoâ€™s borrowing Fourth Wing?â€</li>
            <li>Returns: â€œAlex returned the books they borrowed on Nov 12thâ€</li>
            <li>Pagination: â€œnext pageâ€, â€œprevious pageâ€</li>
            <li>Closing: â€œcloseâ€, â€œdismissâ€, or â€œcancelâ€</li>
            <li>Clear filters: â€œclearâ€</li>
          </ul>
        </div>
      </button>
      <button id="btn-login" aria-label="Sign in" title="Sign in with Google">Sign in</button>
      
      <div class="menu" id="hamburger">
        <button class="menu-toggle" aria-label="Menu" aria-expanded="false" aria-haspopup="true">â˜°</button>
        <div class="menu-list" role="menu">
          <button id="btn-import" role="menuitem">Import</button>
          <button id="btn-export" role="menuitem">Export</button>
          <button id="btn-settings" role="menuitem">Settings</button>
        </div>
      </div>
      <input id="file-import" type="file" accept="application/json" style="display:none" />
    </div>
  </header>

  <main>
    <section id="shelves" aria-live="polite"></section>
  </main>
  <!-- Auth Overlay -->
  <div id="auth-overlay" hidden class="auth-overlay">
    <div class="auth-bg" aria-hidden="true">
      <div id="auth-wall" class="auth-wall" aria-hidden="true"></div>
      <div class="auth-scrim" aria-hidden="true"></div>
    </div>
    <div class="auth-panel" role="dialog" aria-modal="true" aria-labelledby="auth-title">
      <div class="auth-brand">ğŸ“š</div>
      <h2 id="auth-title">Welcome to Library Tracker!</h2>
      <p class="auth-copy">Sign in with Google to sync your library across devices.</p>
      <div class="auth-actions">
        <button id="btn-auth-google" type="button" class="accent">Sign in with Google</button>
      </div>
    </div>
  </div>


  <div id="book-modal" class="modal" aria-hidden="true" role="dialog" aria-modal="true"></div>
  <div id="scanner-overlay" hidden></div>
  <div id="handsfree-overlay" hidden>
    <div id="hf-cursor" class="hf-cursor" aria-hidden="true"></div>
  </div>
  <div id="toast-container" aria-live="polite" aria-atomic="true"></div>

  <!-- Settings Panel -->
  <div id="settings-panel" hidden></div>

  <!-- Hands-Free Info Modal -->
  <div id="hf-info-modal" aria-hidden="true">
    <div class="info-modal-panel" role="dialog" aria-modal="true" aria-labelledby="hf-info-title">
      <button class="close" type="button" data-close="hf-info-modal" aria-label="Close">âœ•</button>
      <h3 id="hf-info-title">How to use Motion Cursor</h3>
      <ul>
        <li>Move your hand to move the onâ€‘screen cursor.</li>
        <li>Pinch your thumb and index finger, and hold briefly to click.</li>
        <li>Hover briefly over buttons to highlight them.</li>
        <li>Open Settings â†’ Hands-Free to adjust sensitivity, mirror X, and dwell time.</li>
      </ul>
    </div>
  </div>

  <!-- Voice Info Modal -->
  <div id="voice-info-modal" aria-hidden="true">
    <div class="info-modal-panel" role="dialog" aria-modal="true" aria-labelledby="voice-info-title">
      <button class="close" type="button" data-close="voice-info-modal" aria-label="Close">âœ•</button>
      <h3 id="voice-info-title">How to use Voice</h3>
      <p>Try these examples:</p>
      <ul>
        <li>Finding: â€œDo I have Fourth Wing?â€ â€” opens the book or filters results</li>
        <li>Borrowing: â€œLend Fourth Wing to Alexâ€ â€” records a borrow today</li>
        <li>Borrowing with date: â€œAlex started borrowing Fourth Wing last Tuesdayâ€</li>
        <li>Removing: â€œRemove Fourth Wingâ€ â€” then say â€œyesâ€ to confirm</li>
        <li>Whoâ€™s borrowing: â€œWhoâ€™s borrowing Fourth Wing?â€</li>
        <li>Borrowerâ€™s books: â€œWhich books is Alex borrowing?â€</li>
        <li>Returns: â€œAlex returned the books they borrowed on November 12thâ€</li>
        <li>Pagination: â€œnext pageâ€, â€œprevious pageâ€</li>
        <li>Closing: â€œcloseâ€, â€œdismissâ€, or â€œcancelâ€</li>
        <li>Clear filters: â€œclearâ€</li>
      </ul>
    </div>
  </div>

  <!-- External libraries -->
  <!-- idb loaded via dynamic import in db.js to avoid MIME/CORS issues -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>

  <!-- Our scripts -->
  <script src="js/utils.js"></script>
  <script src="js/db.js"></script>
  <script src="js/api.js"></script>
  <script src="js/shelves.js"></script>
  <script src="js/modal.js"></script>
  <script src="js/barcode.js"></script>
  <script src="js/search.js"></script>
  <script src="js/importExport.js"></script>
  <script src="js/handsfree.js"></script>
  <script src="js/voice.js"></script>
  <script src="js/settings.js"></script>
  <script src="js/migrate.js"></script>
  <script src="js/main.js"></script>
  <!-- Pager controls -->
  <div id="pager" class="pager" aria-label="Pagination controls" hidden>
    <button id="btn-prev-page" class="pager-btn" aria-label="Previous page" title="Previous page">âŸ¨</button>
    <button id="btn-next-page" class="pager-btn" aria-label="Next page" title="Next page">âŸ©</button>
  </div>
</body>
</html>
